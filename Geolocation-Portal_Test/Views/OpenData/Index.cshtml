@model IEnumerable<Geolocation_Portal_Test.Models.record>

@{
    ViewBag.Title = "Open-Data der Stadt Mosbach";
}

<h1>Open Data Portal</h1>
<hr />

<div id="toolBar">
    <div>
        <a class="nolink" href="#" id="" title="Geo-Data-Warenkorb"><i class="fa fa-map-marker"></i><sub>2</sub></a>
        <a class="nolink" href="#" id="search_button" title="Suchen"><i class="fa fa-search"></i></a>
        <a class="nolink" href="#" id="sort_settings_button" title="Sortieren"><i class="fa fa-sort-amount-asc"></i></a>
        <a class="nolink" href="#" id="filter_button" title="Filtern"><i class="fa fa-filter"></i></a>
        @if (Session["UserRole"] != null && Convert.ToInt32(Session["UserRole"]) < 3)
        {
            <a class="nolink" href="@Url.Action("Recorderstellung", "OpenData")" title="Datensatz hinzufügen"><i class="fa fa-plus"></i></a>

            if (Session["ShowAllRecords"] != null && Convert.ToBoolean(Session["ShowAllRecords"]) == false)
            {
                Session["ShowAllRecords"] = true;
                <a id="showAllRecords_button" class="nolink" href="@Url.Action("Index", "OpenData", new { restriction_string = "all_records" })" title="Alle Datensätze anzeigen">
                    <i class="fa fa-eye"></i>
                </a>
            }
            else
            {
                Session["ShowAllRecords"] = false;
                <a id="showAllRecords_button" class="nolink" href="@Url.Action("Index", "OpenData", new { restriction_string = "all_active_records" })" title="Alle aktiven Datensätze anzeigen">
                    <i class="fa fa-eye-slash"></i>
                </a>
            }
        }
    </div>

    <!-- Start of the filter function -->
    <div id="filter_settings" style="display: none; text-align: left;">
        <ul class="list-inline" style="margin: 0;">
            <li class="list-inline-item"><a class="nolink" href="#" id="filter_settings_category_button" title="Nach Kateogiren filtern">Kategorien</a></li>
            <li class="list-inline-item"><a class="nolink" href="@Url.Action("Index", "OpenData", new { restriction_string = "geo_records" })" title="Nach Geo-Datensätzen filtern">Geo-Datensätze</a></li>
            <li class="list-inline-item"><a class="nolink" href="@Url.Action("Index", "OpenData", new { restriction_string = "dia_records" })" title="Nach Diagramm-Datensätzen filtern">Diagramm-Datensätze</a></li>
            <li class="list-inline-item"><a class="nolink" href="#" id="filter_settings_upload_date_button" title="Nach Upload Datum filtern">Nach Upload-Datum filtern</a></li>
            <li class="list-inline-item"><a class="nolink" href="#" id="filter_settings_file_type_button" title="Nach Dateityp filtern">Nach Dateityp filtern</a></li>
        </ul>
    </div>
    <div id="filter_settings_categories" style="display: none; text-align: left;">
        @foreach (var item in ViewBag.category)
        {
            <a href="@Url.Action("Index", "OpenData", new { categoryID = item.Id })"><img class="icon" width="20" height="20" src="~/icons/Category/@item.icon" title="@item.name" /></a>
        }
    </div>
    <div id="filter_settings_upload_date" style="display: none; text-align: left;">
        <ul class="list-inline" style="margin: 0;">
            <li class="list-inline-item"><a class="nolink" href="#">Letzte Woche</a></li>
            <li class="list-inline-item"><a class="nolink" href="#">Letzten Monat</a></li>
            <li class="list-inline-item"><a class="nolink" href="#">Dieses Jahr</a></li>
        </ul>
    </div>
    <div id="filter_settings_file_type" style="display: none; text-align: left;">
        <ul class="list-inline" style="margin: 0;">
            <li class="list-inline-item"><a class="nolink" href="#">.docx</a></li>
            <li class="list-inline-item"><a class="nolink" href="#">.pdf</a></li>
            <li class="list-inline-item"><a class="nolink" href="#">.geojson</a></li>
        </ul>
    </div>
    <!-- End of the filter function -->
    <!-- Start of the sort function -->
    <div id="sort_settings" style="display: none; text-align: left;">
        <ul class="list-inline" style="margin: 0;">
            <li class="list-inline-item"><a class="nolink" href="@Url.Action("Index", "OpenData", new { restriction_string = "sort_alpha_asc" })" title="Nach Kateogiren filtern"><i class="fa fa-sort-alpha-asc"></i></a></li>
            <li class="list-inline-item"><a class="nolink" href="@Url.Action("Index", "OpenData", new { restriction_string = "sort_alpha_desc" })" title="Nach Geo-Datensätzen filtern"><i class="fa fa-sort-alpha-desc"></i></a></li>
            <li class="list-inline-item"><a class="nolink" href="@Url.Action("Index", "OpenData", new { restriction_string = "sort_date_asc" })" title="Nach Diagramm-Datensätzen filtern"><i class="fa fa-arrow-down"></i><i class="fa fa-calendar"></i></a></li>
            <li class="list-inline-item"><a class="nolink" href="@Url.Action("Index", "OpenData", new { restriction_string = "sort_date_desc" })" title="Nach Diagramm-Datensätzen filtern"><i class="fa fa-arrow-up"></i><i class="fa fa-calendar"></i></a></li>
        </ul>
    </div>
    <!-- End of the sort function -->
    <!-- Start of the search function -->
    <div id="search" style="display: none;">
        @using (Html.BeginForm("Index", "OpenData", FormMethod.Post, htmlAttributes: new { @class = "n-column-wrapper" }))
        {
            <input class="float-right form-control" type="search" placeholder="Suchbegriff..." aria-label="Search" name="search" required="required" pattern="[A-Za-z0-9]{1,20}" />
            <button class="btn btn-primary float-right" style="width: 200px; margin-left: 5px;" type="submit" name="submit">Suchen</button>
        }
    </div>
    <!-- End of the search function -->
</div>

<p id="userInfoMessage">
    @if (ViewBag.userInfoMessage != null)
    {
        // Output of the number of search results.
        @ViewBag.userInfoMessage
        if (ViewBag.resetRestriction)
        {
            <a href="@Url.Action("Index", "OpenData")">Alle Datensätze anzeigen</a>
        }
    }
</p>

<div class="card-columns">
    @foreach (var item in Model)
    {
        <div class="card bg-light mb-3" style="max-width: 40rem;">
            <div class="card-block">
                <div class="card-header">
                    <img class="icon" width="20" height="20" src="~/icons/Category/@Html.DisplayFor(modelItem => item.category.icon)" />
                    <a class="nolink font-weight-bold" href="@Url.Action("Recorddetails", "OpenData", new { id = item.Id })" title="Details anzeigen">
                        @Html.DisplayFor(modelItem => item.title)
                    </a>

                        @if (Session["UserRole"] != null && Convert.ToInt32(Session["UserRole"]) < 3)
                        {
                            // Role concept: Administrator (id = 1) and key user (id = 2) may edit and delete data records.
                            <div class="fa-pull-right">
                                <a class="nolink" href="@Url.Action("Recordbearbeitung", "OpenData", new { id = item.Id })" title="Datensatz bearbeiten"><i class="fa fa-edit"></i></a>
                                <a class="nolink" href="@Url.Action("Recordentfernung", "OpenData", new { id = item.Id })" title="Datensatz löschen"><i class="fa fa-trash"></i></a>
                            </div>
                        }
                    </div>
                    <div class="card-body">
                        <div class="card-subtitle">
                            <div class="d-flex justify-content-between">
                                <span>
                                    <i class="fa fa-calendar"></i>
                                    @Html.DisplayFor(modelItem => item.dataset_modified_date.ToString().Split(new char[] { ' ' })[0])
                                </span>
                                <span><i class="fa fa-download"></i> @item.file.Sum(f=>f.download_count)</span>
                                @Html.Partial("_rating", item.rating)
                            </div>
                        </div>
                        <p class="card-text">
                            @if (@Html.DisplayFor(modelItem => item.description).ToString().Length > 100)
                            {
                                // On the overview page, the descriptions should be no longer than 100 characters.
                                // To retain umlauts after the ToString() method, the string must be encoded.
                                string record_description = item.description.ToString();
                                byte[] utf8_bytes = System.Text.Encoding.UTF8.GetBytes(record_description);
                                var description_substring = System.Text.Encoding.UTF8.GetString(utf8_bytes);
                                description_substring = description_substring.ToString().Substring(0, 100);

                            @description_substring
                            <span>...</span>
                        }
                        else
                        {
                            @Html.DisplayFor(modelItem => item.description)
                        }
                    </p>
                    <div class="text-right">
                        <a href="@Url.Action("Recorddetails", "OpenData", new { id = item.Id })" title="Details anzeigen">Weiterlesen</a>
                    </div>
                </div>
                    <div class="card-footer" style="min-height:50px;">
                        @foreach (var file in item.file)
                        {
                            //
                            if (item.geo_data == true)
                            {
                                <span>
                                    <a class="nolink float-right ml-2" href="~/GeoData/index/@item.Id" title="Vorschau auf der Karte"><i class="fa fa-map"></i></a>

                                    <a class="nolink float-right ml-2" href="javascript:void(0);" onclick="addMapRecordToShoppingCart(@item.Id)" title="Zum Kartenwarenkorb hinzufügen">
                                        <i class="fa fa-map-marker"></i>
                                    </a>
                                </span>
                            }
                            else if (item.dia_data == true)
                            {
                                <span>
                                    <a class="nolink float-right ml-2" href="~/DiagramData/index/@item.Id" title="Vorschau als Diagramm"><i class="fa fa-pie-chart"></i></a>
                                </span>
                            }

                            <span>
                                <a href="@Url.Action("Download", "OpenData", new { fileName = file.name, recordId = item.Id})">
                                    <img class="float-left mr-2" width="25" height="25" src="~/icons/@Html.DisplayFor(modelItem => file.file_icon)-icon.png" />
                                </a>
                            </span>

                            }
                    </div>
            </div>
        </div>
    }
</div> 
<script type="text/javascript">
    /**
     * Add a Record ID to a map shopping cart to display multiple geographical data on the map at once.
     */
    function addMapRecordToShoppingCart(btnClicked) {
        console.log("addMapRecordToShoppingCart Method called");

        // Check if session variable exists.
        if (localStorage["MapRecordShoppingCart"] == null) {
            localStorage["MapRecordShoppingCart"] = "";
        }

        // Parse session variable value to string.
        var recordIdList = JSON.parse(localStorage["MapRecordShoppingCart"]);

        // Change the font size of the page.
        if (isFontLarge == true) {
            Session["MapRecordShoppingCart"] += data;
        } else {
            // Fehlermeldung ausgeben.
            $("#userInfoMessage").html = "";
        }

        // Add to shopping-cart
        $('html').css('font-size', newFontSize);
    }


    /**
     * Toolbar: show and hide setting ranges.
     */
    jQuery(document).ready(function(){
        jQuery("#filter_button").click(function() {
            if ($("#filter_settings_category_button").hasClass("myactive")) {
                jQuery("#filter_settings_categories").slideToggle("slow");
            }

            if ($("#filter_settings_upload_date_button").hasClass("myactive")) {
                jQuery("#filter_settings_upload_date").slideToggle("slow");
            }

            if ($("#filter_settings_file_type_button").hasClass("myactive")) {
                jQuery("#filter_settings_file_type").slideToggle("slow");
            }

            jQuery("#filter_settings").slideToggle("slow");

            changeActiveState("#filter_button");
        });

        jQuery("#filter_settings_category_button").click(function() {
            jQuery("#filter_settings_categories").slideToggle("slow");

            changeActiveState("#filter_settings_category_button");
        });

        jQuery("#filter_settings_upload_date_button").click(function () {
            jQuery("#filter_settings_upload_date").slideToggle("slow");

            changeActiveState("#filter_settings_upload_date_button");
        });

        jQuery("#filter_settings_file_type_button").click(function () {
            jQuery("#filter_settings_file_type").slideToggle("slow");

            changeActiveState("#filter_settings_file_type_button");
        });

        jQuery("#sort_settings_button").click(function () {
            jQuery("#sort_settings").slideToggle("slow");
        })
    
        jQuery("#search_button").click(function () {
            jQuery("#search").slideToggle("slow");
        });
    });

    /**
     * This method collapses the settings boxes again when a parent element is collapsed, by adding or deleting a class.
     * 
     * param: button_id = the id of the button to add or remove the class.
     */
    function changeActiveState(button_id) {
        if ($(button_id).hasClass("myactive")) {
            $(button_id).removeClass("myactive");
        } else {
            $(button_id).addClass("myactive");
        }
    }
</script>
